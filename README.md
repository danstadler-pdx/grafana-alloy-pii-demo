# grafana-alloy-pii-demo
This repo helps you understand the process of adding/configuring the Alloy "mask module" with a locally running 
instance of Alloy.

## Demo Architecture/components

### 1) Grafana Alloy
Runs on your local machine in this demo, enabling you to quickly make changes and try them, before moving to K8s
or other deployments of Alloy.

### 2) Vault
Also local - holds the credentials Alloy needs for shipping to Grafana Cloud Logs. (Example setup steps to be added soon).

### 3) Grafana Cloud Logs
The back-end to which your log files will be shipped.


## Repo Contents

### demo-app/loggerapp.sh
This is a bash program which you can run without dependencies; it generates log messages into the file you specify.
You can add extend the set of use cases in order to add new PII examples.
Note that the log file location/name you specify here must match what you have in alloy-config/config.alloy.)


### alloy-config/config.alloy
This is a config file for Grafana Alloy. It reads the log file generated by loggerapp.sh, imports/configures the 
components from the Alloy masking module, adds those components to the pipeline, and then ships the log data
through the pipeline and then out to Grafana Cloud Logs.


### downloaded-alloy-modules/downloaded-alloy-modules.alloy
This is a locally-saved version of this file:
https://github.com/grafana/alloy-modules/blob/main/modules/kubernetes/annotations/logs/mask.alloy

There are several recommended ways to include modules with Alloy; loading a local file is just one of them.

You should explore the documented options for loading module files, here:
https://grafana.com/docs/alloy/latest/concepts/modules/#importing-modules

This version of the file has a few minor fixes, which were filed as PRs on the Grafana Alloy repo:
https://github.com/grafana/alloy-modules/pull/19
https://github.com/grafana/alloy-modules/pull/18


## Instructions

All of the steps below have been tested on:
1) Install via Homebrew on MacOS 14.4
2) Install via Apt on Ubuntu 22.04

The steps below will reflect that choice where appropriate.

### 1) Install Grafana Alloy
1) Install via Homebrew
2) Install via Apt
[Follow the path of your choice](https://grafana.com/docs/alloy/latest/get-started/install/) 

### 2) Install Hashicorp Vault
Please note that this is optional; alloy-config/config.alloy uses env vars in several locations; for expediency, you have the option of running this demo with hard-coded values instead, in that file. No other files require env vars as of this time.

1) Install via Homebrew
2) Install via Apt
[Follow the path of your choice](https://developer.hashicorp.com/vault/tutorials/getting-started/getting-started-install#install-vault)
[This was also helpful for me.]()

[start the server](https://developer.hashicorp.com/vault/tutorials/getting-started/getting-started-dev-server)

Copy your root token to a safe location.

### 2) Clone the demo repo
Use git to clone this repo:
https://github.com/danstadler-pdx/grafana-alloy-pii-demo

Cd into the project directory.




### 3) Create environment variables Configure alloy-config/config.alloy

Create the following env vars:

// TODO: add some dummy values here which can be checked into git.

export MASK_MODULE_PATH=""
export LOKI_URL=""

If using Vault:
export VAULT_SERVER=""
export VAULT_PATH=""
export VAULT_TOKEN_PATH=""

If not using Vault: you will need to comment/uncomment the marked lines in the file, and create these env vars:
export MY_CLOUD_LOGS_TENANT_ID=""
export MY_CLOUD_LOGS_WRITE_TOKEN=""


### 3a) Notes on env vars for OSX/homebrew users:



### 4) Replace Alloy's default configuration with your configuration.
Alloy places its main configuration file into specific locations depending on your install choice.
[find the location for OSX](https://grafana.com/docs/alloy/latest/tasks/configure/configure-macos/#configure-grafana-alloy-on-macos)
[find the location for Ubuntu](https://grafana.com/docs/alloy/latest/tasks/configure/configure-linux/#configure-grafana-alloy-on-linux)

Back up your default configuration file.

Then, using the tool of your choice, copy/paste the entire content of alloy-config/config.alloy into your machine's actual alloy config.

